<!DOCTYPE html>
<html>
<head>
  <title>My Virtual Pet</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(to bottom, #fdf6e3, #ffe4e1);
      font-family: 'Courier New', monospace;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    #petImage {
      width: 200px;
      image-rendering: pixelated;
    }

    .bounce {
      animation: bounce 1s infinite alternate ease-in-out;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to   { transform: translateY(-15px); }
    }

    #emotion {
      font-weight: bold;
      text-transform: uppercase;
      color: #d76d77;
    }
    /*Emotion based animations */
    @keyframes shakeScared {
     0%, 100% { transform: translateX(0); }
     25% { transform: translateX(-3px); }
     75% { transform: translateX(3px); }
    }
    @keyframes fadeSick {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes pulseLonely {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes wiggleHungry {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-2deg); }
      75% { transform: rotate(2deg); }
    }
    @keyframes excitedHappy {
     0%   { transform: rotate(0); }
      25%  { transform: rotate(10deg); }
      50%  { transform: rotate(-10deg); }
      75%  { transform: rotate(10deg); }
      100% { transform: rotate(0); }
    }

    .excited {
      animation: excitedHappy 0.6s ease-in-out;
    }


    /* Apply by emotion class */
    .pet.happy  { animation: bounce 1s infinite alternate ease-in-out; }
    .pet.scared { animation: shakeScared 0.5s infinite ease-in-out; }
    .pet.sick   { animation: fadeSick 1.5s infinite ease-in-out; }
    .pet.lonely { animation: pulseLonely 1.5s infinite ease-in-out; }
    .pet.hungry { animation: wiggleHungry 1s infinite ease-in-out; }
    .pet.dead   { opacity: 0.3; animation: none; }

    
    #sparkles {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: gold;
      border-radius: 50%;
      animation: sparkleAnim 1s linear forwards;
    }

    @keyframes sparkleAnim {
      0%   { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }

    #actionButtons {
      margin-top: 20px;
    }

    #actionButtons button {
      margin: 0 10px;
      padding: 10px 15px;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      background-color: #ff9a9e;
      color: white;
      cursor: pointer;
    }

    #actionButtons button:hover {
      background-color: #f67280;
    }

    @keyframes floatHand {
    0%   { transform: translateY(0); opacity: 0.6; }
    50%  { transform: translateY(-10px); opacity: 1; }
    100% { transform: translateY(0); opacity: 0.6; }
    }

  </style>
</head>
<body>

  <!-- Pet Name Modal -->
  <div id="nameModal" style="position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: rgba(249, 187, 208, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10;">
    <div id="welcomeBack" style="display: none;">
      <h2>Welcome back! Continue with <span id="savedName"></span>?</h2>
      <button onclick="hideModal()">Continue</button>
      <button onclick="showRename()">Adopt New Pet üêæ</button>
    </div>

    <div id="renameForm">
      <h2>Name your pet:</h2> 
      <input type="text" id="nameInput" placeholder="e.g., Fluffy" />
      <button onclick="submitName()">Start</button>
    </div>
  </div> <!--Properly closed modal -->

  <!-- Main UI -->
  <button onclick="showNameModal()">Rename ‚úèÔ∏è</button>
  <h1><span id="petName">Your pet</span> is feeling: <span id="emotion">loading...</span></h1>
  <img id="petImage" src="/static/pet_happy.png" alt="Pet Image">
  <div id="sparkles"></div>
  <div id="actionButtons" style="display: none;"></div>
  <audio id="happySound" src="/static/squeak.mp3" preload="auto"></audio>
  <audio id="bgMusic" loop autoplay></audio>
  <audio id="crySound" src="/static/cry.m4a" preload="auto"></audio>
  <audio id="growlSound" src="/static/stomachgrowl.wav" preload="auto"></audio>
  
  <script>
    let sparkleInterval = null;
    let petName = "Your pet";

    function showNameModal() {
      const modal = document.getElementById("nameModal");
      const input = document.getElementById("nameInput");
      input.value = "";
      modal.style.display = "flex";
      input.focus();
    }

    function hideModal() {
      localStorage.setItem("petNameConfirmed", "true");
      document.getElementById("nameModal").style.display = "none";
    }

    async function showRename() {
      await fetch('/action/revive');
      localStorage.removeItem("petNameConfirmed");
      document.getElementById("renameForm").style.display = "block";
      document.getElementById("welcomeBack").style.display = "none";
      showNameModal();
    }

    async function submitName() {
      const input = document.getElementById("nameInput");
      petName = input.value.trim() || "Your pet";
      document.getElementById("petName").textContent = petName;
      document.getElementById("nameModal").style.display = "none";
      localStorage.setItem("petNameConfirmed", "true");

      await fetch('/action/name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: petName })
      });
    }

    async function updatePetState() {
      const res = await fetch('/pet_state');
      const data = await res.json();

      const emotionText = document.getElementById("emotion");
      const petImage = document.getElementById("petImage");
      const actionButtons = document.getElementById("actionButtons");
      const nameText = document.getElementById("petName");
      updateBackgroundMusic(data.emotion);
      emotionText.textContent = data.emotion;
      petImage.src = data.image;

      if (data.name) {
        petName = data.name;
        nameText.textContent = petName;
      }

      const hasSeenWelcome = sessionStorage.getItem("seenWelcome");

      if (!hasSeenWelcome && data.name && data.name !== "Your pet") {
        document.getElementById("savedName").textContent = data.name;
        document.getElementById("renameForm").style.display = "none";
        document.getElementById("welcomeBack").style.display = "block";
        document.getElementById("nameModal").style.display = "flex";
        sessionStorage.setItem("seenWelcome", "true");
      } else if (!localStorage.getItem("petNameConfirmed") || data.name === "Your pet") {
        document.getElementById("renameForm").style.display = "block";
        document.getElementById("welcomeBack").style.display = "none";
        document.getElementById("nameModal").style.display = "flex";
      }

      // ‚ú® Update petImage animation class
      petImage.className = "pet"; // Reset all emotion classes
      petImage.classList.add(data.emotion); // Add new emotion class

      // ‚ú® Sparkle logic only for happy
      if (data.emotion === "happy") {
        if (!sparkleInterval) sparkleInterval = setInterval(createSparkle, 500);
      } else {
        clearInterval(sparkleInterval);
       sparkleInterval = null;
      }

      // üß† Action buttons
      if (data.emotion === "sick") {
      actionButtons.style.display = "block";
      actionButtons.innerHTML = `
      <p>${petName} is sick. Try one of the following:</p>
      <button onclick="sendHeal()">Give Medicine üíä</button>
      <button onclick="sendPet()">Pet It ü§ö</button>
      `;
      } else if (data.emotion === "hungry") {
        actionButtons.style.display = "block";
        actionButtons.innerHTML = `
      <p>${petName} is hungry, feed them ü•©</p>
      <button onclick="sendFeed()">Feed ü•©</button>
     `;
      } else if (data.emotion === "lonely") {
        actionButtons.style.display = "block";
        actionButtons.innerHTML = `
        <p>${petName} is lonely. Try petting it:</p>
        <button onclick="sendPet()">Pet It ü§ö</button>
        `;
      } else if (data.emotion === "dead") {
        actionButtons.style.display = "block";
        actionButtons.innerHTML = `
        <p>${petName} has passed away. üíÄ</p>
        <button onclick="revivePet()">Start Over üîÅ</button>
        `;
        } else if (data.emotion === "scared") {
        actionButtons.style.display = "block";
        actionButtons.innerHTML = `
        <p>${petName} is feeling scared üò¢ ‚Äî comfort them:</p>
        <div style="animation: floatHand 2s infinite ease-in-out;">üñêÔ∏è</div>
        <button onclick="sendPet()">Pet It ü§ö</button>
        `;
        } else {
           actionButtons.style.display = "none";
      }
    }

    function createSparkle() {
      const sparkle = document.createElement("div");
      sparkle.classList.add("sparkle");
      sparkle.style.left = `${Math.random() * 200 - 100}px`;
      sparkle.style.top = `${Math.random() * -30}px`;
      document.getElementById("sparkles").appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 1000);
    }

    async function sendHeal() {
      await fetch('/action/heal');
      updatePetState();
    }

    async function sendPet() {
    const res = await fetch('/pet_state');
    const data = await res.json();

    const petImage = document.getElementById("petImage");

    if (data.emotion === "happy") {
      petImage.classList.add("excited");
      document.getElementById("happySound")?.play();
    setTimeout(() => petImage.classList.remove("excited"), 600);
    } else if (data.emotion === "hungry") {
     document.getElementById("growlSound").play();
   } else if (["lonely", "sad"].includes(data.emotion)) {
      document.getElementById("crySound").play();
    }

    await fetch('/action/pet');
    updatePetState();
    }



    async function revivePet() {
      await fetch('/action/revive');
      showNameModal();
    }

    document.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      if (key === "h") sendHeal();
      if (key === "f") fetch('/action/feed');
      if (key === "t") fetch('/action/temp');
    });

    document.getElementById("petImage").addEventListener("mouseover", sendPet);

    setInterval(updatePetState, 5000);
 
    async function sendFeed() {
    await fetch('/action/feed');
    updatePetState();
    }
    function updateBackgroundMusic(emotion) {
    const music = document.getElementById("bgMusic");
    let src = "";

    if (emotion === "happy") src = "/static/happy.mp3";
    else if (["sad", "sick", "lonely"].includes(emotion)) src = "/static/sad.wav";
    else if (emotion === "hungry") src = "/static/hungry.wav";
    else if (emotion === "dead") src = "/static/dead.wav";

    if (music.src !== window.location.origin + src) {
    music.src = src;
    music.play(); 
    } 
  }


  </script>
</body>
</html>
